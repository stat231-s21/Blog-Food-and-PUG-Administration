---
title: "Exploring Covid-19 Vaccinations in the United States by Race and Ethnicity"
author: "Food and PUG Administration: Alison, Caroline, Sabrina"
date: "May 18, 2021"
output:
  rmdformats::readthedown:
    css: custom.css
    thumbnails: false
    highlight: NULL

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
library(tidyverse)
library(readr)
library(janitor)
library(naniar)
library(geojsonio)
library(broom)
library(rgeos)
library(shiny)
library(shinythemes)
library(shinyjs)
library(DT)
library(datasets)
library(viridis)
library(maps)
library(leaflet)
library(tigris)


```

# Introduction

The Covid-19 pandemic continues to highlight inequality in health outcomes in the United States. As of April 23rd, 2021, the [CDC](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/investigations-discovery/hospitalization-death-by-race-ethnicity.html#footnote02) reports that Hispanic, Black, and American Indian or Alaska Native people are more likely to test positive for, be hospitalized for, and die from Covid-19 when compared to white, non-Hispanic people. Considering these disparities alongside recent developments in vaccine distribution, we became curious as to how race and ethnicity relate to immunization rates in each state.

Various data sources have presented vaccination progress in terms of each state’s efficiency (use of allocated vaccines) and speed (proportion of population that is vaccinated). We have developed a range of visualizations to consider how race and ethnicity relate to vaccine progress in the United States. 

# Are states vaccinating demographic groups proportionally to their share of the population?

One of our goals was to make a visualization to see whether demographic groups were receiving their share of Covid-19 vaccines. We present this using a Hexbin map, a 2-D density technique where each state is represented with a hexagon, following an example by [Yan Holtz of The R Graph Gallery](https://www.r-graph-gallery.com/328-hexbin-map-of-the-usa.html). The Kaiser Family Foundation [(KFF)](https://www.kff.org/other/state-indicator/covid-19-vaccinations-by-race-ethnicity/?currentTimeframe=0&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D) collects data on the percentage of vaccines that have been distributed to six racial and ethnic group. They began publishing this on March 1, 2021 and have recently been re-publishing this weekly. [KFF](https://www.kff.org/other/state-indicator/distribution-by-raceethnicity/) also maintains a dataset of population distribution by race and ethnicity in each state. We developed a “demographic metric” comparing these two values to be able to indicate whether demographic groups were receiving a proportionate share of vaccinations: 

```{r, include=FALSE}
#### wrangling state demographic data to create demographic metric 
state_demographics <- read_csv("state_demographics.csv", 
                               skip = 2) %>% 
  slice(2:53) %>%
  select(-c(Footnotes, Total, "Multiple Races")) %>%
  rename("State" = "Location") %>%
  clean_names() %>%
  rename("native_pop" = "american_indian_alaska_native",
         "pacific_islander_pop" = "native_hawaiian_other_pacific_islander", 
         "black_pop" = "black",
         "white_pop" = "white", 
         "asian_pop" = "asian", 
         "hispanic_pop" = "hispanic") %>%
  replace_with_na_at(.vars = c("native_pop",
                               "pacific_islander_pop",
                               "asian_pop"),
                     condition = ~ .x == "N/A") %>% # replace N/A with NA
  mutate(asian_pop = as.numeric(asian_pop), # converting chr to num
         native_pop = as.numeric(native_pop),
         pacific_islander_pop = as.numeric(pacific_islander_pop))


####  wrangling  KFF vaccine demographic data for March 1 - April 26

## March 1 
KFF_vax_March1 <- read_csv("KFF_vax_March1.csv", 
                                 col_types = cols(Footnotes = col_character()), 
                                 skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "March 1") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## March 15
KFF_vax_March15 <- read_csv("KFF_vax_March15.csv", 
                           col_types = cols(Footnotes = col_character()), 
                           skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "March 15") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## March 29
KFF_vax_March29 <- read_csv("KFF_vax_March29.csv", 
                            col_types = cols(Footnotes = col_character()), 
                            skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "March 29") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)


## April 5
KFF_vax_April5 <- read_csv("KFF_vax_April5.csv", 
                            col_types = cols(Footnotes = col_character()), 
                            skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "April 5") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## April 12
KFF_vax_April12 <- read_csv("KFF_vax_April12.csv", 
                            col_types = cols(Footnotes = col_character()), 
                            skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "April 12") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## April 19
KFF_vax_April19 <- read_csv("KFF_vax_April19.csv", 
                            col_types = cols(Footnotes = col_character()), 
                            skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "April 19") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## April 26
KFF_vax_April26 <- read_csv("KFF_vax_April26.csv", 
                            col_types = cols(Footnotes = col_character()), 
                            skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "April 26") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## May 3
KFF_vax_May3 <- read_csv("KFF_vax_May3.csv", 
                            col_types = cols(Footnotes = col_character()), 
                            skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "May 3") %>%
  inner_join(state_demographics, by = "state") %>%
    mutate(white_metric = white_vax/white_pop,
           black_metric = black_vax/black_pop,
           hispanic_metric = hispanic_vax/hispanic_pop, 
           asian_metric = asian_vax/asian_pop,
           native_metric = native_vax/native_pop,
           pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

## May 10
KFF_vax_May10 <- read_csv("KFF_vax_May10.csv", 
                         col_types = cols(Footnotes = col_character()), 
                         skip = 2) %>%
  slice(1:51) %>%
  clean_names() %>%
  rename("state" = "location", 
         "pacific_islander_vax" = "native_hawaiian_or_other_pacific_islander_percent_of_vaccinations", 
         "native_vax" = "american_indian_or_alaska_native_percent_of_vaccinations", 
         "white_vax" = "white_percent_of_vaccinations", 
         "black_vax" = "black_percent_of_vaccinations", 
         "hispanic_vax" = "hispanic_percent_of_vaccinations", 
         "asian_vax" = "asian_percent_of_vaccinations") %>%
  select(-c(footnotes)) %>%
  mutate(asian_vax = ifelse(asian_vax == "<.01", "0", asian_vax), # replacing <0.01 with 0
         black_vax = ifelse(black_vax == "<.01", "0", black_vax),
         native_vax = ifelse(native_vax == "<.01", "0", native_vax),
         pacific_islander_vax= ifelse(pacific_islander_vax == "<.01", "0", 
                                      pacific_islander_vax)) %>%
  replace_with_na_at(.vars = c("white_vax",
                               "asian_vax", 
                               "black_vax",
                               "hispanic_vax",
                               "native_vax",
                               "pacific_islander_vax"),
                     condition = ~ .x == "NR") %>% # replace NR (not reported) with NA
  mutate(white_vax = as.numeric(white_vax), # converting from chr to num
         asian_vax = as.numeric(asian_vax),
         black_vax = as.numeric(black_vax),
         hispanic_vax = as.numeric(hispanic_vax),
         native_vax = as.numeric(native_vax),
         pacific_islander_vax = as.numeric(pacific_islander_vax), 
         date = "May 10") %>%
  inner_join(state_demographics, by = "state") %>%
  mutate(white_metric = white_vax/white_pop,
         black_metric = black_vax/black_pop,
         hispanic_metric = hispanic_vax/hispanic_pop, 
         asian_metric = asian_vax/asian_pop,
         native_metric = native_vax/native_pop,
         pacific_islander_metric = pacific_islander_vax/pacific_islander_pop)

# join each KFF_vax_[date] so that the column names are the same, want to 
# be able to use reactive dataset in the shiny app to filter for the date the
# user chooses. 

KFF_vax_join <- KFF_vax_March1 %>%
  rbind(KFF_vax_March15) %>%
  rbind(KFF_vax_March29) %>%
  rbind(KFF_vax_April5) %>%
  rbind(KFF_vax_April12) %>%
  rbind(KFF_vax_April19) %>%
  rbind(KFF_vax_April26) %>%
  rbind(KFF_vax_May3) %>%
  rbind(KFF_vax_May10)

#### DATA WRANGLING FOR HEXBIN MAP 

# Hexagones boundaries in geojson format:  
# https://team.carto.com/u/andrew/tables/andrew.us_states_hexgrid/public/map.
spdf <- geojson_read("us_states_hexgrid.geojson", what = "sp")

# 'fortify' the data to be able to show it with ggplot2 
# (needs to be in data frame format)
# tidy() function is from the broom package
spdf_fortified <- tidy(spdf, region = "google_name") 

# Calculate the centroid of each hexagon to add the label
# gCentroid function is from the rgeos package
centers <- cbind.data.frame(data.frame(gCentroid(spdf, byid=TRUE)
                                       , id=spdf@data$iso3166_2))

# join data_wrangling with spdf_fortified by state
# note: will have many many rows per state still 
# (data_wrangling values will be repeated for each state)
hexbin_wrangling <- spdf_fortified %>%
  mutate(state = str_replace(id, " \\(United States\\)","")) %>%
  left_join(KFF_vax_join, by = "state")

# to plot with categorical value (demographic metric in categories) mapping to color cue:
# create categorical var

hexbin_wrangling <- hexbin_wrangling %>% # change continuous variable to categorical
  mutate(white_metric_cat = cut(white_metric, 
                                breaks = c(-1, 0.5, 0.95, 1.05, 1.5, 10),
                                labels = c("Extrememly below share (<0.50x)", 
                                           "Below share (0.50x-0.95x)", 
                                           "Proportionate share (0.95x-1.05x)",
                                           "Above share (1.05x-1.50x)",
                                           "Extremely above share (>1.50x)")),
         black_metric_cat = cut(black_metric, 
                                breaks = c(-1, 0.5, 0.95, 1.05, 1.5, 10),                                
                                labels = c("Extrememly below share (<0.50x)", 
                                           "Below share (0.50x-0.95x)", 
                                           "Proportionate share (0.95x-1.05x)",
                                           "Above share (1.05x-1.50x)",
                                           "Extremely above share (>1.50x)")),
         hispanic_metric_cat = cut(hispanic_metric, 
                                   breaks = c(-1, 0.5, 0.95, 1.05, 1.5, 10),                                   
                                   labels = c("Extrememly below share (<0.50x)", 
                                              "Below share (0.50x-0.95x)", 
                                              "Proportionate share (0.95x-1.05x)",
                                              "Above share (1.05x-1.50x)",
                                              "Extremely above share (>1.50x)")),
         asian_metric_cat = cut(asian_metric, 
                                breaks = c(-1, 0.5, 0.95, 1.05, 1.5, 10),                                
                                labels = c("Extrememly below share (<0.50x)", 
                                           "Below share (0.50x-0.95x)", 
                                           "Proportionate share (0.95x-1.05x)",
                                           "Above share (1.05x-1.50x)",
                                           "Extremely above share (>1.50x)")),
         native_metric_cat = cut(native_metric, 
                                 breaks = c(-1, 0.5, 0.95, 1.05, 1.5, 10),                                 
                                 labels = c("Extrememly below share (<0.50x)", 
                                            "Below share (0.50x-0.95x)", 
                                            "Proportionate share (0.95x-1.05x)",
                                            "Above share (1.05x-1.50x)",
                                            "Extremely above share (>1.50x)")),
         pacific_islander_metric_cat = cut(pacific_islander_metric, 
                                           breaks = c(-1, 0.5, 0.95, 1.05, 1.5, 10),                                    
                                           labels = c("Extrememly below share (<0.50x)", 
                                                      "Below share (0.50x-0.95x)", 
                                                      "Proportionate share (0.95x-1.05x)",
                                                      "Above share (1.05x-1.50x)",
                                                      "Extremely above share (>1.50x)")))


hexbin_wrangling$white_metric_cat <- factor(hexbin_wrangling$white_metric_cat, 
                                            levels = c("Extrememly below share (<0.50x)", 
                                                       "Below share (0.50x-0.95x)", 
                                                       "Proportionate share (0.95x-1.05x)",
                                                       "Above share (1.05x-1.50x)",
                                                       "Extremely above share (>1.50x)"))

write_csv(hexbin_wrangling, "hexbin_wrangling.csv", append = FALSE)

write_csv(centers, "centers.csv", append = FALSE)

levels(hexbin_wrangling$white_metric_cat)
```


<center> 
Demographic Metric =  <math><mfrac><mi>% of vaccines that went to a given group in a state</mi><mi>% of state population that is made up of that group</mi></mfrac></math>
</center> 


To make this value easier to interpret, we set cutoff values such that demographic metrics were categorized (and colored accordingly) into extremely below share, below share, proportionate share, above share, and extremely above share.

The KFF data begins on March 1st, when states had varying restrictions regarding vaccine eligibility, and spans several weeks past April 19th, the date when all adults became eligible in every US state. This Shiny App (link) allows users to select a demographic group and date of interest. 

```{r, include=FALSE}
# added a [demographic]_metric_cat variable that creates a categorical variable 
# out of the continuous [demographic]_metric variables, with consistent breaks 
# across the 6 demographic groups:
# <=0.49x, 0.50x-0.74x, 0.75x-0.99x, 1.00x-1.24x, 1.25x-1.50x, >=1.50x
hexbin_wrangling <- read_csv("hexbin_wrangling.csv") %>%
  mutate(white_metric_cat = as.factor(white_metric_cat),
         black_metric_cat = as.factor(black_metric_cat), 
         hispanic_metric_cat = as.factor(hispanic_metric_cat),
         asian_metric_cat = as.factor(asian_metric_cat), 
         native_metric_cat = as.factor(native_metric_cat),
         pacific_islander_metric_cat = as.factor(pacific_islander_metric_cat))

# Calculate the centroid of each hexagon to add the label
# gCentroid function is from the rgeos package
centers <- read_csv("centers.csv")

###################################################
# define choice values and labels for user inputs #
###################################################
## hexbin map 

# users choose demographic of interest
demographic_choice_values <- c("white_metric_cat", 
                               "black_metric_cat", 
                               "hispanic_metric_cat", 
                               "asian_metric_cat", 
                               "native_metric_cat",
                               "pacific_islander_metric_cat")
demographic_choice_names <- c("White",
                              "Black",
                              "Hispanic", 
                              "Asian",
                              "American Indian or Alaska Native",
                              "Native Hawaiian or Other Pacific Islander")
names(demographic_choice_values) <- demographic_choice_names

# user chooses date
date_choice_values <- c("March 1", "March 15", "March 29", "April 5", 
                        "April 12", "April 19", "April 26", "May 3", "May 10")
date_choice_names <- c("March 1", "March 15", "March 29", "April 5", 
                       "April 12", "April 19", "April 26", "May 3", "May 10")
names(date_choice_values) <- date_choice_names


############
#    ui    #
############

ui <- navbarPage(theme=shinytheme("united"),
  
  title = "Covid Vaccinations by Demographic", 
  
  #### HEXBIN MAP (Sabrina)
  # color by demographic metric (white_vax / white_pop)
  # interactivity: demographic of interest
  
  tabPanel(
    title = "Hexbin Map", 
    sidebarLayout(
      sidebarPanel(
        selectInput(inputId = "map_demographic", 
                    label = "Choose a racial or ethnic group of interest to plot:", 
                    choices = demographic_choice_values, 
                    selected = "white_metric_cat"), 
        radioButtons(inputId = "date_choice"
                     , label = "Choose a date:"
                     , choices = date_choice_values
                     , selected = "March 1"),
      ), 
      mainPanel(
        plotOutput(outputId = "hexbin_map") 
      )
    )
  ))
############
# server   #
############

server <- function(input, output){
  
  #### HEXBIN MAP (Sabrina)
  # color by demographic metric (white_vax / white_pop)
  # interactivity: demographic of interest, select date
  data_for_hexbin <- reactive({
    data <- filter(hexbin_wrangling, date == input$date_choice)
  })
  
  output$hexbin_map <- renderPlot({
    ggplot() +
      geom_polygon(data=data_for_hexbin()
                   , aes_string(x="long", y="lat", group="group", fill=input$map_demographic)) +
      geom_text(data=centers, aes(x=x, y=y, label=id)
                , color="white", size=3, alpha=0.6) +
      theme_void() +
      labs(fill = "Ratio of % vaccinations to % of population", 
           title = "Covid-19 vaccination proportionality by demographic group", 
           caption = paste("Data as of", input$date_choice, ", 2021  \n states shaded in grey had no data available")) +
      scale_fill_manual(breaks = c("Extrememly below share (<0.50x)", 
                                   "Below share (0.50x-0.95x)", 
                                   "Proportionate share (0.95x-1.05x)",
                                   "Above share (1.05x-1.50x)",
                                   "Extremely above share (>1.50x)"), 
                        values = c("#FEBA80FF", 
                                   "#F8765CFF", 
                                   "#D3436EFF",
                                   "#982D80FF",
                                   "#5F187FFF"), 
                        labels = c("Extrememly \nbelow share \n(<0.50x)", 
                                   "Below share \n(0.50x-0.95x)", 
                                   "Proportionate share \n(0.95x-1.05x)",
                                   "Above share \n(1.05x-1.50x)",
                                   "Extremely \nabove share \n(>1.50x)"),
                        drop=FALSE,
                        guide = guide_legend(keyheight = unit(3, units = "mm")
                                             , keywidth=unit(12, units = "mm")
                                             , label.position = "bottom"
                                             , title.position = 'top'
                                             , nrow=1)
                        , na.value = "grey") + 
      theme(legend.position = c(0.5, 0.9)
            , text = element_text(color = "#22211d")
            , plot.background = element_rect(fill = "#f5f5f2", color = NA)
            , panel.background = element_rect(fill = "#f5f5f2", color = NA)
            , legend.background = element_rect(fill = "#f5f5f2", color = NA)
            , plot.title = element_text(size= 22, hjust=0.5, color = "#4e4d47"
                                        , margin = margin(b = -0.1, t = 0.4, l = 2, unit = "cm")))
  })}

####################
# call to shinyApp #
####################
shinyApp(ui = ui, server = server)
```


Looking at each demographic group, we can observe some shifts in the number of states (51 including D.C.) reporting data by race and ethnicity (from March 1st to May 10th) as well as vaccine distribution proportionality: 

# {.tabset .tabset-fade .tabset-pills}

## Overview
Across the country and over time, White and Asian people are receiving more than their share of vaccines while Black and Hispanic people are receiving less than their share. American Indians and Pacific Islanders are also receiving less than their share, though data is more sparse for these groups. Vaccine distribution for all demographic groups except American Indians or Alaska Natives has become more equitable in terms of moving away from either “extremely below share” or “extremely above share” 

## White 
* 10 states (20%) missing on March 1, 2021 - 4 states (8%) missing on May 10, 2021
* Shift to more states distributing a “proportionate share” of vaccines to those who are White over time, though the Northeastern region continues to fall into “above share”

## Black 
* 10 states (20%) missing on March 1, 2021 - 4 states (8%) missing on May 10, 2021
* Earlier maps show most states at “extremely below share” or “below share”, while later maps shift to mostly “below share” with only South Dakota and Pennsylvania at “extremely below share”
* Vermont is consistently below share, despite [April eligibility criteria](https://khn.org/news/article/vermont-gives-blacks-and-other-minority-residents-vaccine-priority/) that allowed people of color to be able to register for a vaccine before the general adult population

## Hispanic
* 15 states (29%) missing on March 1, 2021 - 8 states (16%) missing on May 10, 2021
* Earlier maps show most states at “extremely below share” or “below share”, while later maps shift to mostly “below share” with only Arizona, Colorado, and Iowa at “extremely below share”
* Alabama, D.C., Louisiana, Maine, Missouri, Vermont, Virginia shift from “below share” to “above share” as the general adult population becomes eligible

## Asian
* 14 states (27%) missing on March 1, 2021 - 8 states (16%) missing on May 10, 2021
* Earlier maps show a range of all categories (from “extremely below share” to “extremely above share”) then shift to have 7 states (16% of those reporting) below share

## American Indian or Alaska Native
* 20 states (39%) missing on March 1, 2021 - 14 states (27%) missing on May 10, 2021
* Consistently showing over 50% of reporting states at “extremely below share”

## Native Hawaiian or Other Pacific Islander
* Consistently have 42 (82%) states missing
* Earlier maps show 89% of reporting states at “extremely below share” but 33% in later maps 

# Does vaccine hesitancy explain inequity in distribution?

We also wanted to measure to what extent people’s hesitation to get the vaccine has affected lack of vaccinations by racial groups on a national scale. Using data from both [KFF](https://www.kff.org/other/state-indicator/percent-of-total-population-that-has-received-a-covid-19-vaccine-by-race-ethnicity/) for vaccinations and the [Morning Consult](https://morningconsult.com/covid19-vaccine-dashboard/) for hesitancy, we created a bar chart that compares the percentage of people in each racial group that reported that they were either uncertain or unwilling to get the vaccine with the percentage that have not been vaccinated. To further compare these values, we also added a ratio that accounts for the percentage of people who are hesitant to get vaccinated out of those who aren't vaccinated, again by racial group.

```{r, include=FALSE}
# manually creating dataset
# morning consult data on hesitancy
race <- c("Black", "White", "Hispanic", "Other")
vacc <- c(31,53, 34, 46)
planvacc <- c(21, 16, 28, 25)
uncertain <- c(21, 13, 19, 13)
unwilling <- c(27, 19, 19, 16)
black_hes <- 21+27
hisp_hes <- 19+19
white_hes <- 13 +19
other_hes <- 13+16
hestiancydata <- data.frame(race, vacc, planvacc, uncertain, unwilling)

# KFF data on vaccine distribution total demographic group population 
bardata <- read_csv("may 3.csv", 
    skip = 2) %>%
  slice(1:1) %>%
  select("% of Total White Population Vaccinated", 
         "% of Total Black Population Vaccinated", 
         "% of Total Hispanic Population Vaccinated", Location ) %>%
  rename("white_vacc" = "% of Total White Population Vaccinated",  
         "black_vacc" =  "% of Total Black Population Vaccinated",
         "hisp_vacc" = "% of Total Hispanic Population Vaccinated") %>%
  mutate(white_nvacc = 1- white_vacc, black_nvacc= 1-black_vacc, hisp_nvacc = 1- hisp_vacc) 

bardata$black_hes <- .21+.27
bardata$hisp_hes <- .19+.19
bardata$white_hes <- .13 +.19

race <- c("Black", "Black", "Black", "White", "White","White", "Hispanic", "Hispanic", "Hispanic")
measure <- c("Not Vaccinated", "Hesitant","Ratio (Hesitant / Not Vaccinated)", "Not Vaccinated", "Hesitant","Ratio (Hesitant / Not Vaccinated)", "Not Vaccinated", "Hesitant", "Ratio (Hesitant / Not Vaccinated)")
value <- c(.75, .48, .64, .51, .32,.63, .73, .38, .52)
bardata1 <- data.frame(race, measure, value)
```

```{r}
ggplot(bardata1, 
       aes(fill=measure, 
           y=value, 
           x=race)) + 
    geom_bar(position="dodge", 
             stat="identity") + 
  scale_fill_brewer(palette = "Set2") +
  labs( 
    title = "Does vaccine hesitancy account for lack of vaccinations among racial groups?", 
    y = "Percentage",  
    x = "Race", 
    fill = "Measure")
```

Here, we see that Black Americans are most hesitant to get the vaccine, followed by Hispanics, and then White. This makes sense given the history of racial discrimination in the healthcare system that has, understandingly, led to a general distrust of government led health initiatives. It is also worth noting that the percentage of non vaccinated people by racial group shows the same trend, with Blacks having the highest and whites the lowest. This suggests that there could be a correlation between the two measures, but it could be more useful to analyze what percentage of non vaccinated people said they were hesitant to get the vaccine. By dividing the hesitant percentage by the non vaccinated percentage, we are able to do this.

Ratio values for Black and White Americans is fairly high, indicating that a majority of those who wish to get vaccinated from those groups are able to do so. For Hispanic Americans, the ratio is slightly lower, which shows that about half of Hispanics who are not hesitant to get the vaccine still have not been vaccinated. This aligns with our previous data, as the demographic metric for Hispanics seemed to be lower than that for Black and White people. Some factors that could contribute to this difference may lie in the fact that out of these 3 groups, Hispanics are more likely to be immigrants, so language and citizenship barriers are present. However, we also have to keep in mind that age and other factors such as predisposed conditions have allowed some to get vaccinated earlier than others, so a percentage of those not vaccinated and not hesitant simply could have not been eligible at the time we collected our data. 

# Considering vaccine distribution and COVID-19 cases at the county level


## Texas


```{r, include=FALSE}
texas_counties <- map_data(map = "county"
                         , region = ".") %>%
  filter(region == "texas") %>%
  mutate(county_name = str_to_title(subregion)) %>%
  select(-c(region, subregion)) %>%
  mutate(county_name = paste0(county_name, " County" ))
  

#### wrangling texas vaccination
texas_vaccine_data <- read_csv("texas_vaccine_data_by_race.csv")%>%
  clean_names() %>%
  filter(race_ethnicity != "Unknown") %>%
  filter(county_name != "Other") %>%
  filter(county_name != "Grand Total") %>%
  pivot_wider(names_from = race_ethnicity
              , values_from = c(doses_administered
                                , people_fully_vaccinated
                                , people_vaccinated_with_at_least_one_dose)) %>%
  mutate(county_name = paste0(county_name, " County" ))

#### wrangling texas population data
texas_population_data <-read_csv("alldata.csv") %>%
  filter(County != "STATE OF TEXAS") %>%
  filter(Age == "All Ages") %>%
  select(c(County
           , Total
           , NH_White_Total
           , NH_Black_Total
           , NH_Asian_Total
           , NH_Other_Total
           , Hispanic_Total)) %>%
  rename("asian_population" = "NH_Asian_Total"
         , "black_population" = "NH_Black_Total"
         , "hispanic_population" = "Hispanic_Total"
         , "white_population" = "NH_White_Total"
         , "other_population" = "NH_Other_Total"
         , "total_population" = "Total") %>%
 mutate(County = str_to_title(County)) %>%
  rename("county_name" = "County")
#%>%
  #separate(County, into=c("county_name", "remove"), remove = FALSE) %>%
 # select(-c(remove, County))

texas_total <- read_csv("texas_total.csv", 
                col_types = cols(`Total Doses Allocated` = col_number(), 
                `Vaccine Doses Administered` = col_number(), 
                `People Vaccinated with at least One Dose` = col_integer(), 
                `People Fully Vaccinated` = col_number())) %>%
  clean_names() %>%
  select(c(county_name, people_fully_vaccinated)) %>%
  mutate(county_name = paste0(county_name, " County" ))
  
texas_county_fips <- read_csv("texas_county_fips.csv", 
                              col_types = cols(`FIPS #` = col_character())) %>%
  clean_names() %>%
  mutate("COUNTYFP" = fips_number)




#### joining 
texas_data <- texas_vaccine_data %>% 
  inner_join(texas_population_data, by = "county_name") %>%
  inner_join(texas_total, by = "county_name") %>%
  mutate(asian_fully = people_fully_vaccinated_Asian/asian_population
         , hispanic_fully = people_fully_vaccinated_Hispanic/hispanic_population
         , black_fully = people_fully_vaccinated_Black/black_population
         , white_fully = people_fully_vaccinated_White/white_population
         , other_fully = people_fully_vaccinated_Other/other_population
         , total_fully = people_fully_vaccinated/total_population) %>%
  inner_join(texas_counties, by = "county_name") 

tracts <- tracts(state = 'TX', cb=TRUE) %>%
  inner_join(texas_county_fips, by = "COUNTYFP") %>%
  mutate(county_name = paste0(county_name, " County" ))

texas_merged <- geo_join(tracts, texas_data, "county_name", "county_name")

popup <- paste0(texas_merged$county_name
                , "<br>"
                , "<br>"
                , "Percent of Total population fully vaccinated: "
                , round(texas_merged$total_fully,2)
                , "<br>"
                , "<br>"
                , "Percent of Asian population fully vaccinated: "
                , round(texas_merged$asian_fully,2)
                , "<br>"
                , "Percent of Black population fully vaccinated: "
                , round(texas_merged$black_fully,2)
                , "<br>"
                , "Percent of Hispanic population fully vaccinated: "
                , round(texas_merged$hispanic_fully,2)
                , "<br>"
                , "Percent of White population fully vaccinated: "
                , round(texas_merged$white_fully,2))

pal <- colorNumeric(
  palette = "YlGnBu",
  domain = texas_merged$total_fully
)
pal <- colorNumeric(
  palette = "YlGnBu",
  domain = texas_merged$total_fully
)

texas_vax_map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = texas_merged, 
              fillColor = ~pal(total_fully), 
              color = "#b2aeae", 
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup) %>%
  addLegend(pal = pal, 
            values = texas_merged$total_fully, 
            position = "bottomright", 
            title = "Percent of Total Population <br> Fully Vaccinated")
 


```

``` {r eval=FALSE}
popup <- paste0(texas_merged$county_name
                , "<br>"
                , "<br>"
                , "Percent of Total population fully vaccinated: "
                , round(texas_merged$total_fully,2)
                , "<br>"
                , "<br>"
                , "Percent of Asian population fully vaccinated: "
                , round(texas_merged$asian_fully,2)
                , "<br>"
                , "Percent of Black population fully vaccinated: "
                , round(texas_merged$black_fully,2)
                , "<br>"
                , "Percent of Hispanic population fully vaccinated: "
                , round(texas_merged$hispanic_fully,2)
                , "<br>"
                , "Percent of White population fully vaccinated: "
                , round(texas_merged$white_fully,2))

pal <- colorNumeric(
  palette = "YlGnBu",
  domain = texas_merged$total_fully
)
pal <- colorNumeric(
  palette = "YlGnBu",
  domain = texas_merged$total_fully
)

texas_vax_map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = texas_merged, 
              fillColor = ~pal(total_fully), 
              color = "#b2aeae", 
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup) %>%
  addLegend(pal = pal, 
            values = texas_merged$total_fully, 
            position = "bottomright", 
            title = "Percent of Total Population <br> Fully Vaccinated")
 

```

```{r}
texas_vax_map
```

# {.tabset .tabset-fade .tabset-pills}

## Black
I'll put the text here

# References
CDC. (2021, April 23). Risk for COVID-19 Infection, Hospitalization, and Death By Race/Ethnicity. https://www.cdc.gov/coronavirus/2019-ncov/covid-data/investigations-discovery/hospitalization-death-by-race-ethnicity.html

Galewitz, P. (2021, April 5). Vermont to Give Minority Residents Vaccine Priority. Kaiser Health News. https://khn.org/news/article/vermont-gives-blacks-and-other-minority-residents-vaccine-priority/

Holtz, Y. (n.d.). Hexbin map in R: an example with US states. The R Graph Gallery. Retrieved May 17, 2021, from https://www.r-graph-gallery.com/328-hexbin-map-of-the-usa.html

Kaiser Family Foundation. (n.d.). COVID-19 Vaccinations by Race/Ethnicity. Retrieved May 17, 2021, from https://www.kff.org/other/state-indicator/covid-19-vaccinations-by-race-ethnicity/

Kaiser Family Foundation. (2020, October 23). Population Distribution by Race/Ethnicity. https://www.kff.org/other/state-indicator/distribution-by-raceethnicity/

Kaiser Family Foundation. (2021, May 12). Percent of Total Population that has Received a COVID-19 Vaccine by Race/Ethnicity. https://www.kff.org/other/state-indicator/percent-of-total-population-that-has-received-a-covid-19-vaccine-by-race-ethnicity/

Laughlin, N. (2021, May 13). Vaccine Opposition Closely Mirrors Trump Vote by State; Pace of Vaccinations Stalls Among Young Adults. Morning Consult. https://morningconsult.com/covid19-vaccine-dashboard/